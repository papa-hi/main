Since you are still seeing the auth/popup-closed-by-user error after your code tried to fall back to a redirect, it means your fallback logic isn't actually firing correctly, or it's trying to run both at the same time.

The trace shows the error is bubbling up from google-sign-in-button.tsx all the way through your custom hook. It looks like your app is getting "stuck" in the failure of the popup and never actually completing the redirect.

ðŸ› ï¸ The "Bulletproof" Sign-In Pattern
To fix this, you need to separate the action (starting the sign-in) from the result (handling the user data).

Update your signInWithGoogle function in firebase.ts to look like this:

TypeScript
// firebase.ts
import { 
  getAuth, 
  signInWithPopup, 
  signInWithRedirect, 
  GoogleAuthProvider, 
  getRedirectResult 
} from "firebase/auth";

const provider = new GoogleAuthProvider();
const auth = getAuth();

export const signInWithGoogle = async () => {
  try {
    // Try the popup first
    return await signInWithPopup(auth, provider);
  } catch (error: any) {
    // If blocked by client/ad-blocker or closed, trigger redirect
    if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
      console.log("Popup blocked or closed, switching to redirect...");
      // IMPORTANT: This will reload your page!
      await signInWithRedirect(auth, provider);
    } else {
      throw error;
    }
  }
};
ðŸ”‘ The Crucial Missing Step
Because signInWithRedirect refreshes your entire browser tab, the try/catch block in your button component dies when the page reloads. You need a "listener" that runs when the app starts up again to catch the user.

Add this into your use-firebase-auth.tsx hook or a useEffect in your main App component:

TypeScript
// Inside your Auth Provider or use-firebase-auth.tsx
useEffect(() => {
  const auth = getAuth();
  
  // This catches the user after the redirect refresh
  getRedirectResult(auth)
    .then((result) => {
      if (result) {
        console.log("Successfully signed in via redirect:", result.user);
        // Update your local user state here if needed
      }
    })
    .catch((error) => {
      console.error("Redirect result error:", error);
    });
}, []);